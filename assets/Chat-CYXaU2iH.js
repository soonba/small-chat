import{r as i,j as t}from"./@react-vendor-DfZ2FJF2.js";import{Q as K,i as N,h as q,g as _,j as G,M as D,T as W,B as Z,k as C,d as J,f as M,b as S,u as Y,l as F,L,c as I,I as p,a as U,m as V,n as X,o as ee,F as te,p as se}from"./index-BrH10NPX.js";import{b as O,f as ae,g as re,S as ne}from"./@networking-vendor-C--vnpcj.js";import{M as R,S as ie,F as oe,a as ce,b as le,c as ue}from"./SystemMessage-Dd_3Drfh.js";import"./date-vyRSbLjM.js";import{E as de}from"./@emoji-vendor-CdfoxVGn.js";var he=class extends K{constructor(e,s){super(e,s)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(e,s){super.setOptions({...e,behavior:N()},s)}getOptimisticResult(e){return e.behavior=N(),super.getOptimisticResult(e)}fetchNextPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"backward"}}})}createResult(e,s){var l,f;const{state:a}=e,n=super.createResult(e,s),{isFetching:o,isRefetching:u,isError:h,isRefetchError:c}=n,r=(f=(l=a.fetchMeta)==null?void 0:l.fetchMore)==null?void 0:f.direction,d=h&&r==="forward",g=o&&r==="forward",m=h&&r==="backward",x=o&&r==="backward";return{...n,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:_(s,a.data),hasPreviousPage:q(s,a.data),isFetchNextPageError:d,isFetchingNextPage:g,isFetchPreviousPageError:m,isFetchingPreviousPage:x,isRefetchError:c&&!d&&!m,isRefetching:u&&!g&&!x}}};function me(e,s){return G(e,he)}function fe({title:e,titleId:s,...a},n){return i.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":s},a),e?i.createElement("title",{id:s},e):null,i.createElement("path",{fillRule:"evenodd",d:"M7.84 1.804A1 1 0 0 1 8.82 1h2.36a1 1 0 0 1 .98.804l.331 1.652a6.993 6.993 0 0 1 1.929 1.115l1.598-.54a1 1 0 0 1 1.186.447l1.18 2.044a1 1 0 0 1-.205 1.251l-1.267 1.113a7.047 7.047 0 0 1 0 2.228l1.267 1.113a1 1 0 0 1 .206 1.25l-1.18 2.045a1 1 0 0 1-1.187.447l-1.598-.54a6.993 6.993 0 0 1-1.929 1.115l-.33 1.652a1 1 0 0 1-.98.804H8.82a1 1 0 0 1-.98-.804l-.331-1.652a6.993 6.993 0 0 1-1.929-1.115l-1.598.54a1 1 0 0 1-1.186-.447l-1.18-2.044a1 1 0 0 1 .205-1.251l1.267-1.114a7.05 7.05 0 0 1 0-2.227L1.821 7.773a1 1 0 0 1-.206-1.25l1.18-2.045a1 1 0 0 1 1.187-.447l1.598.54A6.992 6.992 0 0 1 7.51 3.456l.33-1.652ZM10 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z",clipRule:"evenodd"}))}const xe=i.forwardRef(fe),ge=e=>{const s=i.useRef(new IntersectionObserver(o=>{o.forEach(u=>{u.isIntersecting&&e()})},{root:document.getElementById("chat-container"),threshold:.8})),a=i.useCallback(o=>{s.current.observe(o)},[]),n=i.useCallback(o=>{s.current.unobserve(o)},[]);return[a,n]};function ve({isOpen:e,modalData:s,onClose:a,onConfirm:n}){const[o,u]=i.useState(""),h=i.useCallback(async r=>{r.preventDefault(),n({name:o})},[n,o]),c=i.useMemo(()=>!o||o.length<3||(s==null?void 0:s.name)!==o,[o,s==null?void 0:s.name]);return t.jsx(D,{isOpen:e,title:"채팅방 삭제하기",onClose:a,children:t.jsxs("form",{className:"space-y-4 sm:space-y-8",onSubmit:h,children:[t.jsxs("div",{children:[t.jsx("p",{className:"mb-1 text-12-SB-16 text-white sm:text-16-SB-24 dark:text-primary-100",children:"삭제하려는 채팅방 제목을 입력하세요."}),t.jsx(W,{maxLength:20,minLength:3,value:o,autoFocus:!0,onChange:u})]}),t.jsx(Z,{disabled:c,size:"medium",text:"삭제하기",type:"submit",variant:"contained"})]})})}const pe=async e=>O(`/v2/chats/${e}`).then(s=>s.data),be=()=>{const{id:e}=C(),s=e||"";return J({queryFn:()=>pe(s),queryKey:M.detail(s),select:n=>n})},ye=async(e,s)=>O(`/v2/chats/${e}/messages`,{nextCursor:s||null}).then(a=>a.data),je=e=>{const{onChatJoin:s}=S(),a=i.useRef(!1),{data:n,...o}=me({getNextPageParam:()=>{},getPreviousPageParam:u=>Number(u.nextCursor)>0?u.nextCursor:void 0,initialPageParam:"",queryFn:({pageParam:u})=>ye(e,u),queryKey:M.history(e),refetchOnMount:!0,refetchOnReconnect:!1,refetchOnWindowFocus:!1});return i.useEffect(()=>{!a.current&&e&&(a.current=!0,s([e]))},[e]),{data:n,...o}},we=async({chatId:e})=>ae("/v2/chats",{chatId:e}).then(s=>s.data),Ce=({onError:e,onSuccess:s})=>Y({mutationFn:we,onError:n=>{e&&e(n)},onSuccess:()=>{s&&s()}}),Pe=({data:e,isLoading:s,ref:a,socketMessages:n})=>{const{accountId:o}=F(),[u,h]=i.useState(0);return i.useEffect(()=>{const c=()=>{window.innerWidth>=425?h(window.innerHeight-56-102):h(window.innerHeight-56-62)};return c(),window.addEventListener("resize",c),()=>{window.removeEventListener("resize",c)}},[]),t.jsxs("ul",{className:"flex w-full flex-col-reverse gap-y-5 overflow-auto p-5 scrollbar-hide",id:"chat-container",style:{height:u,overflowAnchor:"none"},children:[n==null?void 0:n.map((c,r)=>t.jsx(R,{data:c,isSender:c.userId===o},r)),e.map((c,r)=>{const d=c.sender===null?!1:c.sender.userId===o;return c.sender===null?t.jsx(ie,{text:c.message},r):t.jsx(R,{data:{...c,nickname:c.sender.nickname,userId:c.sender.userId},isSender:d},r)}),t.jsx("li",{ref:a,className:"h-px w-full"}),s&&t.jsx("li",{className:"flex h-32 w-full items-center justify-center",children:t.jsx(L,{})})]})};function ke({onSubmit:e}){const{id:s}=C(),a=s||"",{onToast:n}=I(),o=i.useRef(null),[u,h]=i.useState(!1),c=i.useRef(null),[r,d]=i.useState(""),g=i.useCallback(()=>{if(a){if(navigator.clipboard)navigator.clipboard.writeText(a);else{const l=document.createElement("textarea");l.value=a,document.body.appendChild(l),l.select(),document.execCommand("copy"),document.body.removeChild(l)}n("채팅방 코드가 복사되었습니다.",{canDismiss:!0,delay:3e3})}else n("문제가 발생하였습니다. 잠시 후에 다시 시도해 주세요.",{canDismiss:!0,delay:5e3})},[a,n]),m=i.useCallback(()=>{e(r.trim()),d("")},[e,r]),x=i.useCallback(l=>{l.shiftKey&&l.key==="Enter"?d(f=>`${f}
`.trim()):!l.isComposing&&l.key==="Enter"&&(l.preventDefault(),r.trim().length>0?m():n("메시지를 입력해 주세요!",{canDismiss:!0,delay:5e3}))},[r,m,n]),b=i.useCallback(l=>{h(!1),d(f=>f+l.emoji)},[]);return i.useEffect(()=>{c.current&&(c.current.style.height="auto",c.current.style.height=`${c.current.scrollHeight}px`)},[r]),i.useEffect(()=>{function l(f){var y;u&&!((y=o.current)!=null&&y.contains(f.target))&&h(!1)}return document.addEventListener("mousedown",l),()=>{document.removeEventListener("mousedown",l)}},[u]),t.jsxs("div",{ref:o,className:"fixed inset-x-0 bottom-0 w-full divide-y divide-primary-900 border-t border-t-primary-900 bg-white dark:divide-primary-100 dark:border-t-primary-100 dark:bg-black",children:[t.jsxs("div",{className:"flex w-full items-center gap-5 py-2.5 pl-2.5 pr-5",children:[t.jsx("textarea",{ref:c,className:"h-6 flex-1 resize-none bg-transparent text-18-R-28 text-primary-900 outline-none ring-0 transition-all scrollbar-hide placeholder:text-primary-900/50 dark:text-primary-100 dark:placeholder:text-primary-100/30",maxLength:140,value:r,onChange:l=>d(l.currentTarget.value),onKeyDown:l=>x(l.nativeEvent)}),t.jsxs("div",{className:"flex shrink-0 items-center gap-x-5 [&_svg]:text-primary-900 dark:[&_svg]:text-primary-100",children:[t.jsx(p,{"aria-label":"open emoji picker",size:"medium",title:"이모티콘 보기",variant:"text",icon:t.jsx(oe,{}),onClick:()=>h(l=>!l)}),r?t.jsx(p,{"aria-label":"send message",disabled:!r||r.trim().length===0,size:"medium",title:"메시지 보내기",variant:"text",icon:t.jsx(le,{}),onClick:m}):t.jsx(p,{"aria-label":"copy chat id",size:"medium",title:"코드 공유하기",variant:"text",icon:t.jsx(ce,{}),onClick:g})]})]}),t.jsx(de,{searchDisabled:!0,height:300,style:{borderRadius:0,border:"none"},theme:re(ne.MODE),width:"100%",lazyLoadEmojis:!0,onEmojiClick:b,open:u})]})}function Le(){const e=U(),{id:s}=C(),a=s||"",{accountId:n,nickname:o}=F(),{mode:u,onModeChange:h}=V(),{onToast:c}=I(),{data:r}=be(),{data:d,fetchPreviousPage:g,hasPreviousPage:m,isFetchingPreviousPage:x,isLoading:b}=je(a),{isPending:l,mutate:f}=Ce({onError(v){c(v.message,{delay:5e3})},onSuccess(){P(a),e("/",{replace:!0})}}),y=i.useMemo(()=>{var v;return((v=d==null?void 0:d.pages)==null?void 0:v.flatMap(H=>H.data).reverse())||[]},[d==null?void 0:d.pages]),{message:z,onCurrentChatLeave:P,onMessageSend:$}=S(),j=i.useRef(null),[w,k]=i.useState(!1),[T,B]=ge(()=>{setTimeout(()=>{k(!1),g()},1e3)}),E=X({onConfirm(){f({chatId:a})}}),Q=()=>{r!=null&&r.chatName&&E.onOpen({name:r.chatName})},A=v=>{n&&o?$({messageBody:{chatId:a,message:v,nickname:o,userId:n}}):c(`문제가 발생하였습니다.
잠시 후에 다시 시도해주세요.`,{delay:5e3})};return i.useEffect(()=>{j.current&&(!w&&!x&&m&&(k(!0),T(j.current)),m||B(j.current))},[w,x,m]),t.jsxs(t.Fragment,{children:[t.jsx("header",{className:"fixed inset-x-0 top-0 z-10 shadow-sm shadow-primary-50 dark:shadow-primary-100",children:t.jsxs("div",{className:"flex h-14 w-full items-center justify-between pl-2.5 pr-2.5 sm:pr-5",children:[t.jsxs(ee,{className:"flex items-center gap-1",onClick:()=>P(a),to:"/",children:[t.jsx(ue,{className:"size-6 text-white sm:size-8 dark:text-primary-100"}),t.jsx("h1",{className:"text-center font-jua text-18-R-28 text-white sm:text-24-R-32 dark:text-primary-100",children:(r==null?void 0:r.chatName)||""})]}),t.jsxs("div",{className:"flex flex-1 items-center justify-end gap-x-2.5 sm:gap-5",children:[t.jsx(p,{"aria-label":"leave chat",size:"small",title:"채팅방 나가기",variant:"text",icon:t.jsx(xe,{}),onClick:Q}),t.jsx(p,{"aria-label":`change to ${u==="light"?"dark":"light"} mode`,size:"small",title:`${u==="light"?"다크":"라이트"} 모드로 변경하기`,variant:"text",icon:u==="light"?t.jsx(te,{}):t.jsx(se,{}),onClick:h})]})]})}),t.jsxs("main",{className:"flex size-full flex-col justify-between pt-14",children:[t.jsx(ve,{...E}),b||l?t.jsx("div",{className:"flex h-[calc(100vh-theme(spacing.14))] w-full items-center justify-center",children:t.jsx(L,{})}):t.jsxs(t.Fragment,{children:[t.jsx(Pe,{ref:j,data:y,isLoading:w||x,socketMessages:z||[]}),t.jsx(ke,{onSubmit:A})]})]})]})}export{Le as default};
